name: Auto Close and Solve Issues
on:
  pull_request:
    branches:
      - release/*
      - master
    types:
      - closed
permissions:
  contents: read
  issues: write
  pull-requests: read
jobs:
  extract_issue_number:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      issue_numbers: ${{ steps.extract.outputs.issue_numbers }}
    steps:
      - name: Extract issue numbers from PR title
        id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prTitle = context.payload.pull_request.title;
            core.info(`PR Title: ${prTitle}`);
            
            // Match all issue numbers at the end of the title
            // Supports formats like: #123, #456, #789 or #123 #456 #789
            const endPattern = /((?:#\d+[\s,]*)+)\s*$/;
            const endMatch = prTitle.match(endPattern);
            
            if (endMatch) {
              // Extract all individual issue numbers
              const issueNumbers = endMatch[1]
                .match(/#(\d+)/g)
                .map(issue => issue.replace('#', ''))
                .filter((value, index, self) => self.indexOf(value) === index); // Remove duplicates
            
              core.info(`Found ${issueNumbers.length} issue number(s): ${issueNumbers.join(', ')}`);
              core.setOutput('issue_numbers', issueNumbers.join(' '));
            } else {
              core.warning('No issue numbers found at the end of PR title');
              core.setOutput('issue_numbers', '');
            }

  auto_close_and_solve:
    needs: extract_issue_number
    if: needs.extract_issue_number.outputs.issue_numbers != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Add "solved" label and close issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumbers = "${{ needs.extract_issue_number.outputs.issue_numbers }}"
              .split(' ')
              .filter(num => num.trim() !== '');
            
            core.info(`Processing ${issueNumbers.length} issue(s): ${issueNumbers.join(', ')}`);
            core.startGroup('Processing Issues');
            
            let successCount = 0;
            let failureCount = 0;
            
            for (const issueNumber of issueNumbers) {
              try {
                core.startGroup(`Issue #${issueNumber}`);
            
                // Add "solved" label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  labels: ["solved"]
                });
                core.info(`✓ Added "solved" label`);
            
                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  state: "closed"
                });
                core.info(`✓ Closed issue`);
            
                successCount++;
                core.endGroup();
            
              } catch (error) {
                core.error(`✗ Failed to process issue #${issueNumber}: ${error.message}`);
                failureCount++;
                core.endGroup();
              }
            }
            
            core.endGroup();
            
            // Summary
            core.notice(`Successfully processed ${successCount} issue(s)`);
            if (failureCount > 0) {
              core.warning(`Failed to process ${failureCount} issue(s)`);
            }