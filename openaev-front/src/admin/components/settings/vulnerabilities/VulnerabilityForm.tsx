import { zodResolver } from '@hookform/resolvers/zod';
import { Box, Button } from '@mui/material';
import { useTheme } from '@mui/material/styles';
import { type FormEvent, useEffect } from 'react';
import { FormProvider, type SubmitHandler, useForm } from 'react-hook-form';
import { z } from 'zod';

import Tabs, { type TabsEntry } from '../../../../components/common/tabs/Tabs';
import useTabs from '../../../../components/common/tabs/useTabs';
import { useFormatter } from '../../../../components/i18n';
import { type VulnerabilityCreateInput } from '../../../../utils/api-types';
import useEnterpriseEdition from '../../../../utils/hooks/useEnterpriseEdition';
import { zodImplement } from '../../../../utils/Zod';
import EEChip from '../../common/entreprise_edition/EEChip';
import GeneralFormTab from './form/GeneralFormTab';
import RemediationFormTab from './form/RemediationFormTab';

interface Props {
  onSubmit: SubmitHandler<VulnerabilityCreateInput>;
  handleClose: () => void;
  editing?: boolean;
  initialValues?: Partial<VulnerabilityCreateInput>;
}

const VulnerabilityForm = ({
  onSubmit,
  handleClose,
  editing,
  initialValues = {
    vulnerability_external_id: '',
    vulnerability_cvss_v31: undefined,
    vulnerability_description: '',
    vulnerability_source_identifier: '',
    vulnerability_published: '',
    vulnerability_vuln_status: undefined,
    vulnerability_cisa_action_due: '',
    vulnerability_cisa_exploit_add: '',
    vulnerability_cisa_required_action: '',
    vulnerability_cisa_vulnerability_name: '',
    vulnerability_cwes: [],
    vulnerability_reference_urls: [],
    vulnerability_remediation: '',
  },
}: Props) => {
  // Standard hooks
  const { t } = useFormatter();
  const theme = useTheme();

  const {
    isValidated: isValidatedEnterpriseEdition,
    openDialog: openEnterpriseEditionDialog,
    setEEFeatureDetectedInfo,
  } = useEnterpriseEdition();

  const cwesObject = z.object({
    cwe_external_id: z.string().min(1, { message: t('CWE ID is required') }),
    cwe_source: z.string().optional(),
  });

  const schema = zodImplement<VulnerabilityCreateInput>().with({
    vulnerability_external_id: z.string().min(1, { message: t('Should not be empty') }),
    vulnerability_cvss_v31: z.coerce.number().min(0).max(10),
    vulnerability_description: z.string().optional(),
    vulnerability_source_identifier: z.string().optional(),
    vulnerability_published: z.string().optional(),
    vulnerability_vuln_status: z.enum(['ANALYZED', 'DEFERRED', 'MODIFIED']).optional(),
    vulnerability_cisa_action_due: z.string().optional(),
    vulnerability_cisa_exploit_add: z.string().optional(),
    vulnerability_cisa_required_action: z.string().optional(),
    vulnerability_cisa_vulnerability_name: z.string().optional(),
    vulnerability_cwes: z.array(cwesObject).optional(),
    vulnerability_reference_urls: z.array(z.string().url({ message: t('Invalid URL') })).optional(),
    vulnerability_remediation: z.string().optional(),
  });

  const methods = useForm<VulnerabilityCreateInput>({
    mode: 'onTouched',
    resolver: zodResolver(schema),
    defaultValues: {
      ...initialValues,
      vulnerability_published: initialValues?.vulnerability_published ?? undefined,
      vulnerability_vuln_status: initialValues?.vulnerability_vuln_status ?? undefined,
      vulnerability_cisa_action_due: initialValues?.vulnerability_cisa_action_due ?? undefined,
      vulnerability_cisa_exploit_add: initialValues?.vulnerability_cisa_exploit_add ?? undefined,
      vulnerability_cwes: initialValues.vulnerability_cwes ?? [],
      vulnerability_reference_urls: initialValues.vulnerability_reference_urls ?? [],
      vulnerability_remediation: initialValues.vulnerability_remediation ?? '',
    },
  });

  const {
    handleSubmit,
    formState: { isSubmitting, isDirty },
  } = methods;

  const handleSubmitWithoutPropagation = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    e.stopPropagation();
    const isValid = await methods.trigger();
    if (isValid) {
      handleSubmit(onSubmit)(e);
    }
  };
  const tabEntries: TabsEntry[] = [{
    key: 'General',
    label: t('General'),
  }, {
    key: 'Remediation',
    label: (
      <Box display="flex" alignItems="center">
        {t('Remediation')}
        {!isValidatedEnterpriseEdition && (
          <EEChip
            style={{ marginLeft: theme.spacing(1) }}
            clickable
            featureDetectedInfo={t('Remediation')}
          />
        )}
      </Box>
    ),
  }];
  const { currentTab, handleChangeTab } = useTabs(tabEntries[0].key);

  useEffect(() => {
    if (currentTab === 'Remediation' && !isValidatedEnterpriseEdition) {
      handleChangeTab('General');
      setEEFeatureDetectedInfo(t('Remediation'));
      openEnterpriseEditionDialog();
    }
  }, [currentTab, isValidatedEnterpriseEdition]);

  return (
    <FormProvider {...methods}>
      <form
        id="vulnerabilityForm"
        style={{
          display: 'flex',
          flexDirection: 'column',
          minHeight: '100%',
          gap: theme.spacing(2),
        }}
        onSubmit={handleSubmitWithoutPropagation}
      >
        <Tabs
          entries={tabEntries}
          currentTab={currentTab}
          onChange={newValue => handleChangeTab(newValue)}
        />
        {currentTab === 'General' && (
          <GeneralFormTab editing={editing} />
        )}
        {currentTab === 'Remediation' && isValidatedEnterpriseEdition && (
          <RemediationFormTab />
        )}

        <div style={{
          marginTop: 'auto',
          display: 'flex',
          flexDirection: 'row-reverse',
          gap: theme.spacing(1),
        }}
        >
          <Button
            variant="contained"
            color="secondary"
            type="submit"
            disabled={!isDirty || isSubmitting}
          >
            {editing ? t('Update') : t('Create')}
          </Button>
          <Button
            variant="contained"
            onClick={handleClose}
            disabled={isSubmitting}
          >
            {t('Cancel')}
          </Button>
        </div>
      </form>
    </FormProvider>
  );
};
export default VulnerabilityForm;
